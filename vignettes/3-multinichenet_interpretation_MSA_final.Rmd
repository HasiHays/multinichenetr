---
title: 'MultiNicheNet output interpretation: MIS-C: M vs S vs A'
author: "Robin Browaeys"
date: "22-6-2022"
output: html_document
---

# Prepare visualizations

```{r}
library(tidyverse)
library(multinichenetr)
```

Read in MultiNicheNet analysis output, define parameter settings

```{r}
multinichenet_output = readRDS("../output/MNN_output_MSA.rds")

contrast_tbl = tibble(contrast = 
                        c("M-(S+A)/2","S-(M+A)/2", "A-(S+M)/2"), 
                      group = c("M","S","A"))
logFC_threshold = 0.50
p_val_threshold = 0.05
fraction_cutoff = 0.05
top_n_target = 250
```

Read in the NicheNet model

```{r}
### read in NicheNet model
lr_network = readRDS("../../../NicheNet_V2/networks/data/ligand_receptor/lr_network_human_21122021.rds")
lr_network = lr_network %>% dplyr::rename(ligand = from, receptor = to) %>% distinct(ligand, receptor) %>% mutate(ligand = make.names(ligand), receptor = make.names(receptor))
ligand_target_matrix = readRDS("../../../NicheNet_V2/model_construction/models/ligand_target_matrix_nsga2r_final.rds")
colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% make.names()
rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% make.names()
```

Make cell type names more readable

```{r}
mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}

celltype_labels = c(
  "L_T_TIM3._CD38._HLADR." = "TIM3+CD38+HLA-DR+ T cells",
  "L_T_Proliferating" = "Proliferating T cells",
  "L_B_Memory" = "Memory B cells",
  "L_B_Naive" = "Naive B cells",
  "L_T_CD4_Naive" = "Naive CD4 T cells",
  "L_T_CD8_Naive" = "Naive CD8 T cells",
  "L_T_Cytotoxic" = "Cytotoxic T cells",
  "L_T_CD4_Reg" = "CD4 TREGs",
  "L_T_MAIT" = "MAIT cells",
  "L_T_Memory" = "Memory T cells",
  "L_T_Memory_CCR6_enriched" = "CCR6+ Memory T cells",
  "L_T_TRDV2_gd_activated" = "TRDV2+ gd activated T cells",
  "L_NK_CD56hi" = "NK cells CD56hi",
  "L_NK_CD56._CD16." = "NK cells CD56dimCD16hi",
  "M_Monocyte_CD14" = "CD14+ Monocytes",
  "M_Monocyte_CD16" = "CD16+ Monocytes"
)

for(i in seq(length(celltype_labels))){
  old_name = celltype_labels[i] %>% names()
  new_name = celltype_labels[i]
  multinichenet_output$prioritization_tables$group_prioritization_tbl = multinichenet_output$prioritization_tables$group_prioritization_tbl %>% mutate_cond(sender == old_name, sender = new_name) %>% mutate_cond(receiver == old_name, receiver = new_name)
  multinichenet_output$prioritization_tables$sample_prioritization_tbl = multinichenet_output$prioritization_tables$sample_prioritization_tbl %>% mutate_cond(sender == old_name, sender = new_name) %>% mutate_cond(receiver == old_name, receiver = new_name)
  multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl = multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl %>% mutate_cond(receiver == old_name, receiver = new_name)
  multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities = multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% mutate_cond(receiver == old_name, receiver = new_name)
  multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% mutate_cond(receiver == old_name, receiver = new_name)
  multinichenet_output$celltype_info$pb_df = multinichenet_output$celltype_info$pb_df %>% mutate(celltype = as.character(celltype)) %>% mutate_cond(celltype == old_name, celltype = new_name)
  multinichenet_output$lr_target_prior_cor = multinichenet_output$lr_target_prior_cor %>% mutate_cond(sender == old_name, sender = new_name) %>% mutate_cond(receiver == old_name, receiver = new_name)
} 
```

# Circos plot of top-prioritized links: all cell type pairs, top 75 across all groups

```{r}
prioritized_tbl_oi_top75_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, rank_per_group = FALSE)
```

```{r, fig.width=15, fig.height=12}
prioritized_tbl_oi = multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_top75_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% left_join(prioritized_tbl_oi_top75_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique())

colors_sender = c("goldenrod","pink","indianred2",RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers %>% sort())
colors_receiver = c("goldenrod","pink","indianred2",RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers %>% sort())

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)

dev.off()
pdf("../plots_multinichenet/circos_A.pdf", width = 10, height = 10)
circos_list$A
dev.off()
pdf("../plots_multinichenet/circos_M.pdf", width = 10, height = 10)
circos_list$M
dev.off()
pdf("../plots_multinichenet/circos_S.pdf", width = 10, height = 10)
circos_list$S
dev.off()
pdf("../plots_multinichenet/circos_legend.pdf", width = 10, height = 10)
circos_list$legend
dev.off()
circos_list$legend

```

# Circos plot of top-prioritized links: Focus on cell type pairs of interest - top 75 across all groups

### Cell types of interest:  "CD14+ Monocytes", "Proliferating T cells", "CD16+ Monocytes", "TIM3+CD38+HLA-DR+ T cells", "NK cells CD56dimCD16hi", "NK cells CD56hi"

```{r}
celltypes_oi = c( "CD14+ Monocytes", "Proliferating T cells", "CD16+ Monocytes", "TIM3+CD38+HLA-DR+ T cells", "NK cells CD56dimCD16hi", "NK cells CD56hi"  )
```

```{r}
prioritized_tbl_oi_top75_subset = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, rank_per_group = FALSE, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
```

```{r, fig.width=15, fig.height=12}
prioritized_tbl_oi = multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_top75_subset$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% left_join(prioritized_tbl_oi_top75_subset)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique())

colors_sender = c(RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers %>% sort())
colors_receiver = c(RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers %>% sort())

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)

dev.off()
pdf("../plots_multinichenet/circos_A_subset.pdf", width = 10, height = 10)
circos_list$A
dev.off()
pdf("../plots_multinichenet/circos_M_subset.pdf", width = 10, height = 10)
circos_list$M
dev.off()
pdf("../plots_multinichenet/circos_S_subset.pdf", width = 10, height = 10)
circos_list$S
dev.off()
pdf("../plots_multinichenet/circos_legend_subset.pdf", width = 10, height = 10)
circos_list$legend
dev.off()

circos_list$legend

```

### export table with top 1000 differential interactions

```{r}
prioritized_tbl_oi_top1000_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 1000, rank_per_group = FALSE)

contrast_tbl  %>% inner_join(prioritized_tbl_oi_top1000_all) %>% filter(group =="M")  %>% select(-group, -id) %>%  write_tsv("../output/top1000_M.txt")
contrast_tbl  %>% inner_join(prioritized_tbl_oi_top1000_all) %>% filter(group =="A") %>% select(-group, -id)  %>%  write_tsv("../output/top1000_A.txt")
contrast_tbl  %>% inner_join(prioritized_tbl_oi_top1000_all) %>% filter(group =="S") %>% select(-group, -id)  %>%  write_tsv("../output/top1000_S.txt")
```

# Dotplot/Heatmap visualization of scaled ligand-receptor expression product + ligand activities

## All cell types: limited nr of interactions ~ interactions shown in circos plot of the paper

## All cell types

Visualize per group, but make sure all shown interactions are in the top 200 most distinct interactions overall (defined in the next table:)

```{r}
prioritized_tbl_oi_top75_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, rank_per_group = FALSE)
```

### Group adult COVID19

```{r}
group_oi = "A"
```

```{r, fig.height=7, fig.width=15}
plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_top75_all %>% filter(group == group_oi), widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_A_inCircos.pdf", width = 15, height = 7)
```

### Group healthy Siblings

```{r}
group_oi = "S"
```

```{r, fig.height=8.5, fig.width=15}
plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_top75_all %>% filter(group == group_oi), widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_S_top75_inCircos.pdf", width = 15, height = 8.5)
```

### Group MIS-C

```{r}
group_oi = "M"
```

```{r, fig.height=7, fig.width=15}
plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_top75_all %>% filter(group == group_oi), widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_M_top75_inCircos.pdf", width = 15, height = 7)
```


## All cell types

Visualize per group, but make sure all shown interactions are in the top 200 most distinct interactions overall (defined in the next table:)

```{r}
prioritized_tbl_oi_top200_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 200, rank_per_group = FALSE)
```

### Group adult COVID19

```{r}
group_oi = "A"
```

```{r, fig.height=11, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep top 3 receptors per sendder-ligand / receiver combination for visualization
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_A_top75.pdf", width = 16, height = 11)
```

### Group healthy Siblings

```{r}
group_oi = "S"
```

```{r, fig.height=22, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep to3 receptors per sendder-ligand / receiver combination
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_S_top75.pdf", width = 16, height = 22)
```

### Group MIS-C

```{r}
group_oi = "M"
```

```{r, fig.height=22, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep to3 receptors per sendder-ligand / receiver combination
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi

ggsave("../plots_multinichenet/lr_prod_activity_M_top75.pdf", width = 16, height = 22)
```

## Subset of cell types: "CD14+ Monocytes", "Proliferating T cells", "CD16+ Monocytes", "TIM3+CD38+HLA-DR+ T cells", "NK cells CD56dimCD16hi", "NK cells CD56hi"

```{r}
prioritized_tbl_oi_top200_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 200, rank_per_group = FALSE, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
```

### Group adult COVID19

```{r}
group_oi = "A"
```

```{r, fig.height=13, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep to3 receptors per sendder-ligand / receiver combination
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_A_top75_subset.pdf", width = 16, height = 13)
```
### Group healthy Siblings

```{r}
group_oi = "S"
```

```{r, fig.height=18, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep to3 receptors per sendder-ligand / receiver combination
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi
ggsave("../plots_multinichenet/lr_prod_activity_S_top75_subset.pdf", width = 16, height = 18)
```
### Group MIS-C

```{r}
group_oi = "M"
```

```{r, fig.height=20, fig.width=16}
prioritized_tbl_oi_high75 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 75, groups_oi = group_oi, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% group_by(sender, ligand, receiver) %>% top_n(3, prioritization_score) %>% ungroup() # only keep to3 receptors per sendder-ligand / receiver combination
prioritized_tbl_oi_high75 = prioritized_tbl_oi_high75 %>% filter(id %in% prioritized_tbl_oi_top200_all$id)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_high75, widths = c(3,1,1))
plot_oi

ggsave("../plots_multinichenet/lr_prod_activity_M_top75_subset.pdf", width = 16, height = 20)
```

# Ligand-Target inference plots

## Zoom in on target genes downstream of top-predicted ligands

### Group MIS-C

```{r}
group_oi = "M"
```

#### Receiver: CD16+ Monocytes

```{r}
receiver_oi = "CD16+ Monocytes"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Monocyte_CD16.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: CD14+ Monocytes

```{r}
receiver_oi = "CD14+ Monocytes"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Monocyte_CD14.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: TIM3+CD38+HLA-DR+ T cells

```{r}
receiver_oi = "TIM3+CD38+HLA-DR+ T cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_T_TIM3.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: Proliferating T cells 

```{r}
receiver_oi = "Proliferating T cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```


```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_T_prolif.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: NK cells CD56dimCD16hi 

```{r}
receiver_oi = "NK cells CD56dimCD16hi"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```


```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD16.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: NK cells CD56hi 

```{r}
receiver_oi = "NK cells CD56hi"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD56hi.pdf", width = 28, height = 8)
combined_plot$legends
```

#### Receiver: TRDV2+ gd activated T cells

```{r}
receiver_oi = "TRDV2+ gd activated T cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
```

#### Receiver: Memory B cells

```{r}
receiver_oi = "Memory B cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Bmem.pdf", width = 28, height = 8)

```

#### Receiver: MAIT cells

```{r}
receiver_oi = "MAIT cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
```

#### Receiver: CD4 TREGs

```{r}
receiver_oi = "CD4 TREGs"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
```

#### Receiver: Cytotoxic T cells

```{r}
receiver_oi = "Cytotoxic T cells"
prioritized_tbl_oi_high10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)
```

```{r, fig.width=28, fig.height=8}
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_high10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
```

## Visualization of expression-correlated target genes of ligand-receptor pairs

If wanted, we can further filter predicted target genes of ligand-receptor pairs based on expression correlation. For truly affected target genes downstream of ligand-receptor pairs, we expect correlation in expression across patients: higher LR pair expression should be correlated to higher target gene expression.

### Example cell type: CD16+ Monocytes
```{r}
receiver_oi = "CD16+ Monocytes"

lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
```

Now we will visualize the top correlated hits for the LR pairs that are also in the MIS-C specific top 25:

```{r}
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
```

First: show the LR-->Target heatmap of prior knowledge supported and correlated links (shows both measure of correlation and measure of prior knowledge)

```{r, fig.width=25, fig.height=9}
lr_target_prior_cor_heatmap = make_lr_target_prior_cor_heatmap(lr_target_prior_cor_filtered_up %>% filter(receiver == receiver_oi & id %in% prioritized_tbl_oi$id), add_grid = TRUE)
lr_target_prior_cor_heatmap
ggsave("../plots_multinichenet/lig_targets_dot_correlation_Monocyte_CD16.pdf", width = 25, height = 9)
```

Now visualize these links together with the LR and target expression, to visualize the expression correlation

```{r, fig.width=31, fig.height=16}
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_Monocyte_CD16.pdf", width = 31, height = 16)
```

You can also visualize the expression correlation in the following way for a selected LR pair and their targets:

```{r, fig.width=20, fig.height=4}
ligand_oi = "IFNG"
receptor_oi = "IFNGR2"
sender_oi = "Proliferating T cells"
receiver_oi = "CD16+ Monocytes"
lr_target_scatter_plot = make_lr_target_scatter_plot(multinichenet_output$prioritization_tables, ligand_oi, receptor_oi, sender_oi, receiver_oi, multinichenet_output$celltype_info, multinichenet_output$grouping_tbl, lr_target_prior_cor_filtered %>% filter(rank_of_target < 100 & rank_of_ligand < 10))
lr_target_scatter_plot
ggsave("../plots_multinichenet/LR_target_correlation_Monocyte_CD16_IFNG.pdf",lr_target_scatter_plot, width = 21, height = 4)

```

### Other cell type: CD14+ Monocytes

```{r, fig.width=31, fig.height=16}
receiver_oi = "CD14+ Monocytes"
lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_Monocyte_CD14.pdf", width = 31, height = 16)
```

### Other cell type: Proliferating T cells

```{r, fig.width=26, fig.height=13}
receiver_oi = "Proliferating T cells"
lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_T_prolif.pdf", width = 26, height = 13)
```

### Other cell type: TIM3+CD38+HLA-DR+ T cells

```{r, fig.width=31, fig.height=16}
receiver_oi = "TIM3+CD38+HLA-DR+ T cells"
lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_T_TIM3.pdf", width = 31, height = 16)
```

### Other cell type: NK cells CD56dimCD16hi

```{r, fig.width=26, fig.height=13}
receiver_oi = "NK cells CD56dimCD16hi"
lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_NK_CD16.pdf", width = 26, height = 13)
```

### Other cell type: NK cells CD56hi

```{r, fig.width=18, fig.height=11}
receiver_oi = "NK cells CD56hi"
lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi, receiver == receiver_oi)
lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))
lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))
lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 25, groups_oi = group_oi, receivers_oi = receiver_oi)
lr_target_correlation_plot = make_lr_target_correlation_plot(multinichenet_output$prioritization_tables, prioritized_tbl_oi,  lr_target_prior_cor_filtered , multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, receiver_oi,plot_legend = FALSE)
lr_target_correlation_plot$combined_plot
ggsave("../plots_multinichenet/lig_rec_targets_correlation_NK_CD56.pdf", width = 18, height = 11)
```

# Systems view of intercellular communication: intercellular gene regulatory networks

In the next type of plot, we will visualize predicted ligand-target links for target genes that are also ligands or receptors themselves. As a result we can see how ligands in one celltype affect expression of intercellular signaling molecules in other cell types, and how this effects then again other cell types, or feedbacks to the original one.

## All cell types

```{r}
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 2000, rank_per_group = FALSE)
# prioritized_tbl_oi = prioritized_tbl_oi %>% group_by(sender, receiver, ligand) %>% top_n(1, prioritization_score) %>% filter(sender != receiver)
senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique())

colors_sender = c("steelblue2","indianred2","navyblue","limegreen","firebrick","purple",RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers)
colors_receiver = c("steelblue2","indianred2","navyblue","limegreen","firebrick","purple",RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers)
# 
lr_target_prior_cor_filtered = multinichenet_output$prioritization_tables$group_prioritization_tbl$group %>% unique() %>% lapply(function(group_oi){
  lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi)
  lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < top_n_target & rank_of_ligand < 30) & (pearson > 0.25 | spearman > 0.25))
  lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < top_n_target & rank_of_ligand < 30) & (pearson < -0.25 | spearman < -0.25))
  lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
}) %>% bind_rows()

```

```{r, fig.width=32, fig.height=16}
# colors_sender =c("indianred2","steelblue2","limegreen")
graph_plot = make_ggraph_ligand_target_links(lr_target_prior_cor_filtered = lr_target_prior_cor_filtered%>% filter(target %in% intersect(lr_target_prior_cor_filtered$ligand, prioritized_tbl_oi$ligand) ), prioritized_tbl_oi = prioritized_tbl_oi, colors = colors_sender)
graph_plot$plot
graph_plot$source_df_lt %>% head()
graph_plot$nodes_df %>% head()
ggsave("../plots_multinichenet/intercellular_signaling_network.pdf",graph_plot$plot, width = 44, height = 22)
graph_plot$source_df_lt %>% write_tsv("../output/intercellular_signaling_network_source_df.txt")
graph_plot$nodes_df %>% write_tsv("../output/intercellular_signaling_network_node_df.txt")
```

## Subset of Cell types

```{r}
prioritized_tbl_oi = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 500, rank_per_group = FALSE, senders_oi = celltypes_oi, receivers_oi = celltypes_oi)
senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()

colors_sender = c(RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral')) %>% magrittr::set_names(senders_receivers)
colors_sender[3] = "goldenrod"
colors_sender[4] = colors_sender[5]
colors_sender[5] = colors_sender[6]
colors_sender[6] = "purple"

lr_target_prior_cor_filtered = multinichenet_output$prioritization_tables$group_prioritization_tbl$group %>% unique() %>% lapply(function(group_oi){
  lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>% inner_join(multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>% distinct(ligand, target, direction_regulation, contrast)) %>% inner_join(contrast_tbl) %>% filter(group == group_oi)
  lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% filter(direction_regulation == "up") %>% filter( (rank_of_target < 250 & rank_of_ligand < 30) & (pearson > 0.25 | spearman > 0.25))
  lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% filter(direction_regulation == "down") %>% filter( (rank_of_target < 250 & rank_of_ligand < 30) & (pearson < -0.25 | spearman < -0.25))
  lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)
}) %>% bind_rows()

```

```{r, fig.width=32, fig.height=16}
# colors_sender =c("indianred2","steelblue2","limegreen")
graph_plot = make_ggraph_ligand_target_links(lr_target_prior_cor_filtered = lr_target_prior_cor_filtered, prioritized_tbl_oi = prioritized_tbl_oi, colors = colors_sender)
graph_plot$plot
graph_plot$source_df_lt %>% head()
graph_plot$nodes_df %>% head()
ggsave("../plots_multinichenet/intercellular_signaling_network_subset.pdf",graph_plot$plot, width = 38, height = 19)
graph_plot$source_df_lt %>% write_tsv("../output/intercellular_signaling_network_source_df_subset.txt")
graph_plot$nodes_df %>% write_tsv("../output/intercellular_signaling_network_node_df_subset.txt")
```

# Analyze ligand activity signatures in a sender-cell agnostic way

#### Check activities of CCL22, IL21, IL33, IFNA1, IFNB1, IFNG, TNF, CCL4, CCL3: (high serum levels according to the literature - reflected in activity on some cell types?)

```{r, fig.width= 32, fig.height=11}
ligands_oi = multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl %>% inner_join(contrast_tbl) %>% 
  group_by(group, receiver, direction_regulation) %>% distinct(ligand, receiver, group, direction_regulation, activity) %>% 
  top_n(1, activity) %>% pull(ligand) %>% unique()

plot_oi = make_ligand_activity_plots(multinichenet_output$prioritization_tables, ligands_oi, contrast_tbl, widths = NULL)
plot_oi
ggsave("../plots_multinichenet/ligand_activities_all.pdf", width = 33, height = 11)

```

Make a pheatmap plot of these ligand activities!

```{r, fig.width= 32, fig.height=12}
ligands_oi = multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl %>% inner_join(contrast_tbl) %>% 
  group_by(group, receiver, direction_regulation) %>% distinct(ligand, receiver, group, direction_regulation, activity) %>% 
  top_n(1, activity) %>% pull(ligand) %>% unique()

activity_df = multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl %>% dplyr::inner_join(contrast_tbl) %>% dplyr::distinct(group, ligand, receiver, activity, activity_scaled, direction_regulation) %>% dplyr::filter(ligand %in% ligands_oi) %>% dplyr::mutate(group_direction_regulation = paste(group, direction_regulation,sep = "-"))
activity_df = activity_df %>% ungroup() %>% mutate(sample = paste(group_direction_regulation, receiver, sep = "-")) %>% select(sample, ligand, activity_scaled) %>% spread(ligand, activity_scaled)
activity_matrix = activity_df %>% select(-sample) %>% data.frame() %>% as.matrix() %>% magrittr::set_rownames(activity_df$sample) %>% t()
ComplexHeatmap::Heatmap(activity_matrix,
                          cluster_columns = FALSE)

```

For readability reasons, we will only show M and A on the figure for the paper. Only show these ligands as well. 
```{r, fig.width= 26, fig.height=8}
ligands_oi = multinichenet_output$prioritization_tables$ligand_activities_target_de_tbl %>% inner_join(contrast_tbl) %>% filter(group %in% c("M","A")) %>% 
  group_by(group, receiver, direction_regulation) %>% distinct(ligand, receiver, group, direction_regulation, activity) %>% 
  top_n(1, activity) %>% pull(ligand) %>% unique()

plot_oi = make_ligand_activity_plots(multinichenet_output$prioritization_tables, ligands_oi, contrast_tbl, widths = NULL)
plot_oi
ggsave("../plots_multinichenet/ligand_activities_all_MA.pdf", width = 26, height = 8)

```

Focus on some subsets of interesting ligands: 
```{r, fig.width= 32, fig.height=5}
ligands_oi = c("CCL22", "IL21", "IL33", "IFNA1", "IFNB1", "IFNG", "TNF", "CCL4", "CCL3","IL15","IL6","IL1B","IL1A", "EBI3")

plot_oi = make_ligand_activity_plots(multinichenet_output$prioritization_tables, ligands_oi, contrast_tbl, widths = NULL)
plot_oi
```


```{r, fig.width= 32, fig.height=4}
ligands_oi = c("IFNA1", "IFNB1", "IFNG","IL15","IL6","IL1B","IL1A", "TNF")

plot_oi = make_ligand_activity_plots(multinichenet_output$prioritization_tables, ligands_oi, contrast_tbl, widths = NULL)
plot_oi
ggsave("../plots_multinichenet/ligand_activities_subset.pdf", width = 33, height = 4)

```

```{r, fig.width=22, fig.height=8}
group_oi = "M"
receiver_oi = "TRDV2+ gd activated T cells"
prioritized_tbl_oi = tibble(ligand = c("PLA2G2A","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
combined_plot$legends
```
```{r, fig.width=22, fig.height=8}
group_oi = "M"
receiver_oi = "MAIT cells"
prioritized_tbl_oi = tibble(ligand = c("PLA2G2A","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
combined_plot$legends
```

#### Show target genes of the type I interferons

```{r, fig.width=22, fig.height=8}
group_oi = "A"
receiver_oi = "CD16+ Monocytes"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_CD16Mono_IFN_A.pdf", width = 22, height = 8)
combined_plot$legends
```


```{r, fig.width=22, fig.height=7}
group_oi = "M"
receiver_oi = "CD16+ Monocytes"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets__CD16Mono_IFN_M.pdf", width = 22, height = 7)
combined_plot$legends
```


```{r, fig.width=22, fig.height=8}
group_oi = "A"
receiver_oi = "NK cells CD56dimCD16hi"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD16_IFN_A.pdf", width = 22, height = 8)
combined_plot$legends
```
```{r, fig.width=22, fig.height=8}
group_oi = "M"
receiver_oi = "NK cells CD56dimCD16hi"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD16_IFN_M.pdf", width = 22, height = 8)
combined_plot$legends
```

```{r, fig.width=22, fig.height=8}
receiver_oi = "NK cells CD56hi"
group_oi = "A"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD56_IFN_A.pdf", width = 22, height = 8)
combined_plot$legends
```


```{r, fig.width=22, fig.height=8}
receiver_oi = "NK cells CD56hi"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand =c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_NKCD56_IFN_M.pdf", width = 22, height = 8)
combined_plot$legends
ggsave("../plots_multinichenet/lig_targets_NKCD56_IFN_M_legends.pdf", width = 15, height = 8)

```


```{r, fig.width=22, fig.height=8}
receiver_oi = "Proliferating T cells"
group_oi = "A"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Proliferating T cells_IFN_A.pdf", width = 22, height = 8)
combined_plot$legends
```


```{r, fig.width=22, fig.height=8}
receiver_oi = "Proliferating T cells"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Proliferating T cells_IFN_M.pdf", width = 22, height = 8)
combined_plot$legends
```

```{r, fig.width=22, fig.height=8}
receiver_oi = "TIM3+CD38+HLA-DR+ T cells"
group_oi = "A"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_L_T_TIM3_IFN_A.pdf", width = 22, height = 8)
combined_plot$legends
```


```{r, fig.width=22, fig.height=8}
receiver_oi = "TIM3+CD38+HLA-DR+ T cells"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand = c("IFNA1","IFNA16","IFNA21","IFNL3","IFNG"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_L_T_TIM3_IFN_M.pdf", width = 22, height = 8)
combined_plot$legends
```


#### Show target genes of IL15 on the two T cell populations of interest

```{r, fig.width=28, fig.height=8}
receiver_oi = "Proliferating T cells"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand = c("IL15","CCL4","CCL3"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Proliferating T cells_IL15.pdf", width = 28, height = 8)
combined_plot$legends
```

```{r, fig.width=28, fig.height=8}
receiver_oi = "TIM3+CD38+HLA-DR+ T cells"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand = c("IL15","CCL4","CCL3"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_L_T_TIM3_IL15.pdf", width = 28, height = 8)
combined_plot$legends
```

```{r, fig.width=18, fig.height=8}
receiver_oi = "Platelet"
group_oi = "M"
prioritized_tbl_oi = tibble(ligand = c("SAA1","THPO"))
combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
combined_plot$combined_plot
ggsave("../plots_multinichenet/lig_targets_Platelet.pdf", width = 18, height = 8)
combined_plot$legends
```


